## 直接使用xml方式比較方便
```
    ls -l /dev/disk/by-id/
    
    <disk type='block' device='disk'>
      <driver name='qemu' type='raw' cache='none' io='native'/>
      <source dev='/dev/disk/by-id/ata-Samsung_SSD_860_EVO_500GB_S1234567890'/>
      <target dev='vdb' bus='sata'/>
    </disk>
```


## 詳細內容
在 KVM (通常配合 Libvirt/QEMU 使用) 中实现 SATA 硬盘直通（Pass-through）主要有两种方式。请根据你的需求选择：

1. **硬盘映射（Raw Device Mapping, RDM）：** 将物理硬盘作为块设备直接挂载给虚拟机。
    - _优点：_ 简单，不需要特殊的硬件支持（IOMMU），宿主机仍能看到该设备（但不应挂载）。
    - _缺点：_ 虚拟机内很难读取到硬盘的 SMART 信息（除非使用 virtio-scsi 且配置正确）。
2. **PCI 控制器直通（PCI Passthrough）：** 将整个 SATA 控制器通过 IOMMU 直通给虚拟机。
    - _优点：_ 虚拟机拥有对硬盘的完全控制权（包括 SMART 信息、休眠控制等），性能最好。
    - _缺点：_ 需要 CPU/主板支持 VT-d/AMD-Vi，且**宿主机将无法使用连接在该控制器上的任何硬盘**。
绝大多数用户想要的是**第一种（硬盘映射）**。以下是详细操作步骤。
---

### 准备工作：获取硬盘的唯一 ID

**绝对不要**在配置文件中使用 `/dev/sdb` 这种名称，因为重启后盘符可能会变（比如变成了 `/dev/sdc`），导致数据灾难。一定要使用 `/dev/disk/by-id/`。

1. 在宿主机终端输入：
```Bash
    ls -l /dev/disk/by-id/
```

2. 找到你要直通的硬盘。通常格式为 `ata-品牌-型号-序列号`。
    - 例如：`/dev/disk/by-id/ata-Samsung_SSD_860_EVO_500GB_S1234567890`
3. 复制这个全路径。
---

### 方法一：使用 `virt-manager` (图形界面)

如果你安装了桌面环境并使用 `virt-manager` 管理虚拟机：
1. 打开虚拟机详情，确认虚拟机处于**关机**状态。
2. 点击 **"Add Hardware" (添加硬件)**。
3. 选择 **"Storage" (存储)**。
4. 选中 **"Select or create custom storage" (选择或创建自定义存储)**。
5. 在 "Device or path" (设备或路径) 栏中，**粘贴**刚才复制的 `/dev/disk/by-id/...` 路径。
6. 在 "Bus type" (总线类型) 中：
    - 如果为了最大兼容性（模拟真实 SATA），选择 **SATA**。
    - 如果为了性能（推荐），选择 **VirtIO**（Windows 虚拟机需要安装 VirtIO 驱动）。
7. 点击完成，开机即可。

---

### 方法二：使用 `virsh edit` (命令行 XML)
如果你使用命令行管理（如 PVE 底层或纯 Linux 服务器）：
1. 编辑虚拟机配置文件：
```Bash
    virsh edit 虚拟机名称
 ```
    
2. 找到 `<devices>` 段落，在其中添加以下 `<disk>` 配置块：
```XML
    <disk type='block' device='disk'>
      <driver name='qemu' type='raw' cache='none' io='native'/>
      <source dev='/dev/disk/by-id/ata-Samsung_SSD_860_EVO_500GB_S1234567890'/>
      <target dev='vdb' bus='sata'/>
    </disk>
    ```
    
- **注意：** 如果你的 `bus` 设置为 `sata`，`target dev` 必须是 `sda`, `sdb`, `hdc` 这种格式。如果 `bus` 是 `virtio`，则是 `vda`, `vdb`。
        
3. 保存退出，启动虚拟机。

---

### 方法三：PCI 控制器直通 (高级)

如果你需要 TrueNAS/Unraid 等系统完全接管硬盘（例如为了 ZFS 安全或读取 SMART），你需要直通 SATA 控制器。

**前提：** CPU 支持 VT-d (Intel) 或 AMD-Vi (AMD)，且在 BIOS 中已开启。IOMMU 已在 Linux 内核参数中开启 (`intel_iommu=on` 或 `amd_iommu=on`)。

1. **查找 SATA 控制器 ID：**
    
    Bash
    
    ```
    lspci -nn | grep -i sata
    ```
    
    输出示例：`00:17.0 SATA controller [0106]: Intel Corporation ... [8086:a352]`。记住 `00:17.0`。
    
2. **编辑 XML：**
    
    Bash
    
    ```
    virsh edit 虚拟机名称
    ```
    
3. **添加 Hostdev：** 在 `<devices>` 中添加：
    
    XML
    
    ```
    <hostdev mode='subsystem' type='pci' managed='yes'>
      <source>
        <address domain='0x0000' bus='0x00' slot='0x17' function='0x0'/>
      </source>
    </hostdev>
    ```
    
    _注意：直通后，宿主机连在该控制器上的系统盘将无法访问，导致宿主机崩溃。通常需要主板有多个 SATA 控制器，或者加装 PCIE 转 SATA 扩展卡来专门直通。_
    

---

### ⚠️ 重要注意事项（防坑指南）

1. **数据安全（至关重要）：** 当硬盘直通给虚拟机后，**宿主机（Host）千万不要挂载这个硬盘的分区**。
    
    - 如果宿主机和虚拟机同时通过文件系统读写同一个分区，**100% 会导致文件系统损坏和数据丢失**。
        
    - 建议在宿主机的 `/etc/fstab` 中移除该硬盘的挂载项。
        
2. **性能优化：** 对于 `disk type='block'` 方式，确保 XML 中包含 `cache='none' io='native'`。这会让虚拟机绕过宿主机的页面缓存，直接读写物理设备，性能几乎等同于原生。
    
3. **关于 SMART 信息：** 使用方法一和方法二（映射方式），虚拟机内部通常使用 `smartctl` 看不到物理硬盘的真实 SMART 数据。如果你必须要在虚拟机里监控硬盘健康状况，要么使用 **PCI 直通**，要么尝试将总线类型改为 `virtio-scsi` 并开启 passthrough 属性（配置较复杂）。
4. 