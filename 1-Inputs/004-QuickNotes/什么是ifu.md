---
Project:
  - Formal
description:
tags:
  - formal
  - riscv
created: 2025-06-10 | 15:37
parent: Resource
---
# 功能说明
## 概述
- *FTQ 将预测块请求分别发送到 ICache 和 IFU 模块，IFU 等到来自 ICache 返回至多两个缓存行的指令码后*，
	1. 进行切分**产生**取指令请求范围限定的**初始指令码**，
	2. 并送到预译码器进行**预译码**,下一拍根据预译码信息修正有效指令范围，同时进行指令码扩展
	3. 将指令码及其他信息发送给 IBuffer 模块。
- *当 ICache 查询地址属性发现是 MMIO 地址空间时*
	1. IFU 需要将地址发送给 MMIO 处理单元取指令，
	2. 这个时候处理器进入多周期顺序执行模式，
IFU 阻塞流水线直到收到来自 **ROB 的提交信号**时，IFU 才允许下一个取指令请求的进行，同时 IFU 需要对跨页的 MMIO 地址空间 32 位指令做特殊处理（重发机制）。

IFU分为3个流水级

## F0 -  接收FTQ取指令请求
IFU接收来自FTQ以预测块为单位的取指令请求，每个预测块最多包含**32字节指令码**，最多为**16条指令**。IFU需要置位ready驱动FTQ向ICache发送请求.请求如下
- 预测块起始地址
- 起始地址所在cache line的*下一个*cache line开始地址
- 下一个预测块的起始地址
- 该预测块在FTQ里的队列指针、
- 该预测块有无taken的CFI指令（控制流指令）和
- 该taken的CFI指令在预测块里的位置以及请求控制信号（请求是否有效和IFU是否ready）

## F1，F2 切分指令产生初始指令码
- F1流水线先进行PC的计算，以及计算切分缓存行的指针，
	- 计算PC
	- 生成17位的切分指针
- IF2流水级才会得到ICache返回的缓存行，
	- 针对每个指令，取出
		- 对应的异常信息、
		- 物理地址、
		- 客户物理地址等
	- 根据FTQ的taken信息，计算该预测块在无跳转和跳转发生情况下的有效指令范围
		- 无跳转情况下的指令有效范围ftr_range即当前预测块从起始地址到下一个预测块的起始地址的差值
		- 有跳转情况下的指令有效范围jump_range即当前预测块的起始地址到预测块中第一个跳转指令地址的差值
	- 最后，IFU需要从缓存行和上一流水级计算的指针
	- 预译码，由**PreDecode子模块**完成
		- 返回16条指令码

## F3 指令扩展
指令扩展阶段需要分RVC和RVI指令进行考虑，其中RVC指令需要判断合法与否


# MMIO
在处理器上电复位时，内存还没有准备好，此时需要从Flash中取指令执行
这种情况下需要IFU向MMIO总线发送宽度为64位的请求从flash地址空间取指令执行同时IFU**禁止**对MMIO总线的**推测执行**，
- 即IFU需要**等到每一条指令执行完成**得到准确的下一条指令地址之后才继续向总线发送请求