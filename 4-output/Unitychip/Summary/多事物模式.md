---
Project: ["Unitychip"]
Status: Ongoing
---
# Picker Pack 功能增强：多 Transaction 支持与 DUT 抽象层

  

## 1. 背景与目标 (Background & Objective)

**背景**: 当前 `picker pack` 命令仅支持解析单个 UVM Transaction (`sequence_item`) 文件，生成对应的单一 Agent。用户在 Python 端使用时，必须手动管理 Transaction 的创建、赋值和发送，且缺乏统一的视图来操作包含多个接口的复杂 DUT。

  

**目标**:

1. **单 Agent 封装多事物 (Single Agent, Multi-Transaction)**: 支持输入多个 `.sv` 文件（代表不同的接口协议或同一接口的不同事物），生成**一个统一的 Agent**（包含 SV 和 Python 部分），该 Agent 内部管理所有相关的事物通信。

2. **引脚级抽象 (Pin-Level Abstraction)**: 在 Python `DUT` 类中封装底层的 UVM 通信细节，提供类似“操作寄存器/引脚”的直观属性访问（`Set/Get`）和时序控制（`Step`）。

3. **解析能力增强**: 优化 SystemVerilog 解析器，支持非 `rand` 字段的解析。

  

## 2. 核心需求详情 (Detailed Requirements)

  

### 2.1 多事物 (Multi-Transaction) 解析与单 Agent 封装

**输入**: 命令行接收多个 Transaction 定义文件，支持直接列出多个文件或通过 `-f/--filelist` 指定文件列表。

**输出**:

1. 生成的 SystemVerilog 代码包含**一个统一的 UVM Agent**，该 Agent 能够处理所有输入的事物类型（通过多端口或聚合逻辑）。

2. 生成的 Python 代码包含**一个统一的 Agent 类** (`_xagent.py`) 和一个**顶层 DUT 类**。

  

**DUT 映射逻辑**:

假设输入了两个文件 `adder_in.sv` (包含字段 `a`, `b`) 和 `adder_out.sv` (包含字段 `c`)。

统一的 Agent 负责所有字段的底层通信，DUT 类提供统一视图。

  

**Python 使用范例**:

```python

# 初始化统一的 DUT，指定名称（对应命令行参数 -n）

from DUTTop.DUTTop import DUTTop

dut = DUTTop()

  

# 属性访问（通过 .value 访问/修改引脚值）

dut.a.value = 10 # 映射到 adder_in.a

dut.b.value = 20 # 映射到 adder_in.b

  

# 步进：推进仿真时间，自动触发所有变更了数据的 Agent 发送 transaction

dut.Step(1)

  

# 读取结果（从 monitor 自动同步回来的数据）

print(dut.c.value) # 映射到 adder_out.c

```

  

### 2.2 CLI 接口变更

修改 `picker pack` 命令以支持多文件列表和 DUT 命名。

  

* **旧命令**: `picker pack trans.sv`

* **新命令**: `picker pack trans_in.sv trans_out.sv -n DUTTop --generate-dut`

* `[files...]`: 支持多个源文件。

* `-f, --filelist`: (新增) 支持通过文件列表传入多个源文件。

* `-n, --name`: (新增) 指定生成的 Python 顶层类名称。如果不指定，默认命名为 `UnifiedDUT`。

* `--generate-dut`: (复用) 开启生成 DUT 抽象层的功能。

  

### 2.3 解析器优化 (非 rand 字段)

**当前限制**: 解析器仅提取 `rand bit [7:0] data;` 形式的字段。

**新规则**:

1. 解析类中所有 **public** 的成员变量（包括 `bit`, `int`, `byte`, `logic` 等类型）。

2. 忽略 UVM 基类自带的内部变量（如 `m_sequencer`, `print_priority` 等，通常不需要导出）。

3. **结构体支持**: 如果遇到 `struct`，尝试将其展开或映射为 Python 字典/对象（可选，若复杂可暂缓）。

  

## 3. 详细设计规范 (Design Specifications)

  

### 3.1 Python DUT 类结构 (template/uvm/xdut.py)

生成的 Python 类应具备层级化管理能力，并使用 `_PinWrapper` 提供直观的属性访问。

  

```python

class _PinWrapper:

"""提供 dut.field.value 的访问方式"""

def __init__(self, xpin):

self._xpin = xpin

@property

def value(self):

return self._xpin.xdata.value

@value.setter

def value(self, val):

self._xpin.xdata.value = val

  

class {DUT_CLASS_NAME}:

def __init__(self):

# ... 初始化 xspcomm 基础设施 ...

self._xpins = {}

# 初始化统一的 Agent (单 Agent 封装了所有 Transaction 的通信)

# self.agent = Agent("{DUT_NAME}_agent")

  

# 初始化引脚映射

# self._xpins['a'] = xsp.XPin(xsp.XData(8), self._event)

# self._xpins['a'].xdata.AsImmWrite() # 设置为立即写模式，确保赋值后立即生效而不等待时钟沿

# self.a = _PinWrapper(self._xpins['a'])

  

def Step(self, cycles=1):

"""

1. 检查数据变更。

2. 调用统一 Agent.send() 发送数据 (Agent 内部处理不同 Transaction 的路由)。

3. 推进仿真时间。

4. 收集 Monitor 数据并更新本地状态。

"""

pass

```

  

### 3.2 目录结构与生成产物

假设执行命令：`picker pack input.sv output.sv -n MySOC`

生成目录结构建议（参考 `pack_example`，但合并 Agent）：

```text

build/

└── DUTMySOC/ # 以 DUT 名称命名的包目录 (前缀 DUT)

├── __init__.py

├── DUTMySOC.py # 用户接口类 (DUTTop)

├── MySOC_xagent.py # 统一的 Agent 包装类 (处理 input 和 output)

├── MySOC_xagent.sv # 统一的 UVM Agent SV 代码

├── tlm_pbsb.py # 通信层代码

└── ... (编译产物)

```

  

## 4. 案例开发 (Example Development)

在 `example/Pack` 下新增案例 `MultiTransAdder`：

1. **SysVerilog**: 定义 `alu_op.sv` (OpCode, OperandA, OperandB) 和 `alu_result.sv` (Result, Status)。

2. **UVM Env**: 简单的 UVM 环境，接收 `alu_op`，计算后发送 `alu_result`。

3. **Python Test**: 使用新生成的 DUT 类，发送操作码，`Step(1)`，校验结果。

* **时序优化验证**: 验证并优化 `Step` 函数的时序控制，解决当前版本中调用一次 `Step` 可能推进两个周期的时序问题，确保 `Step(n)` 精确推进 `n` 个周期。

  

## 5. 待办事项 (Implementation To-Do)

  

1. **修改 `src/picker.cpp`**:

* 更新 `pack_opts` 结构体，支持 `dut_name` 字段。

* 修改 CLI 解析逻辑，允许 `files` 参数接收多个文件。

* 阻止在未指定 `-n` 且输入多个文件时的默认行为（或提供合理默认值）。

  

2. **修改 `src/parser/uvm.cpp`**:

* 移除 `if (tag == "rand")` 的硬性限制，改为解析所有符合类型定义的类成员。

* 增强类型解析逻辑，确保能处理无 `rand` 修饰的 `bit [x:y] name`。

  

3. **修改 `src/codegen/uvm.cpp`**:

* 重构代码生成逻辑：不再为每个 Transaction 生成单独的 Agent 文件。

* **合并逻辑**: 创建一个统一的 `Agent` 类，将所有输入文件的 Transaction 定义整合其中（或在内部实例化）。

* 将所有 Transaction 的元数据（字段、位宽）合并后传递给 `xdut.py` 和 `xagent.py` 模板。

  

4. **更新模板 `template/uvm/xdut.py`**:

* 支持 Jinja2 循环，遍历传入的所有 Agent/Transaction 列表来生成初始化代码和属性映射。

  

5. **时序优化 (Timing Optimization)**:

* 分析当前的 `Step` 函数实现与底层 UVM `run_phase` 的交互。

* 修正 `Step(1)` 导致推进两个周期的问题，确保 Python 端 `Step` 与 UVM 端时钟周期严格对齐。

  

## 6. 备注

> 编译picker工具，请在/home/sfangyy/work/uvm/202512/picker目录下运行 make build，

> 测试修改效果，也可以在/home/sfangyy/work/uvm/202512/picker目录下运行 bash example/Pack/release-pack.sh dut